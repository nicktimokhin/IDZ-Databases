-- =====================================================
-- DDL-скрипт для системы "Учёт продаж фармацевтических товаров"
-- =====================================================

-- Удаление существующих таблиц (в обратном порядке)
DROP TABLE IF EXISTS "ПозицииЧека" CASCADE;
DROP TABLE IF EXISTS "Чеки" CASCADE;
DROP TABLE IF EXISTS "Партии" CASCADE;
DROP TABLE IF EXISTS "ЛекарственныеСредства" CASCADE;
DROP TABLE IF EXISTS "Поставщики" CASCADE;
DROP TABLE IF EXISTS "Страны" CASCADE;
DROP TABLE IF EXISTS "Клиенты" CASCADE;

-- =====================================================
-- 1. СПРАВОЧНИК СТРАН
-- =====================================================
CREATE TABLE "Страны" (
    "КодОКСМ" INTEGER PRIMARY KEY,
    "НаименованиеСтраны" VARCHAR(100) NOT NULL UNIQUE
);

-- =====================================================
-- 2. СПРАВОЧНИК ЛЕКАРСТВЕННЫХ СРЕДСТВ
-- =====================================================
CREATE TABLE "ЛекарственныеСредства" (
    "РегНомерЛС" VARCHAR(15) PRIMARY KEY,
    "ТорговоеНаименование" VARCHAR(100) NOT NULL,
    "МНН" VARCHAR(50) NOT NULL,
    "ЛекарственнаяФорма" VARCHAR(30),
    "Дозировка" VARCHAR(20),
    "Производитель" VARCHAR(100),
    "КодОКСМ" INTEGER,
    "КодОКПД2" VARCHAR(9) NOT NULL CHECK ("КодОКПД2" ~ '^[0-9]{2}\.[0-9]{2}\.[0-9]{2}\.[0-9]{3}$'),
    "УсловияОтпуска" VARCHAR(20) NOT NULL CHECK ("УсловияОтпуска" IN ('по рецепту', 'без рецепта')),
    
    -- Внешний ключ на справочник стран
    CONSTRAINT fk_лекарственные_средства_страны 
        FOREIGN KEY ("КодОКСМ") REFERENCES "Страны"("КодОКСМ")
);

-- =====================================================
-- 3. СПРАВОЧНИК ПОСТАВЩИКОВ
-- =====================================================
CREATE TABLE "Поставщики" (
    "ИНН" VARCHAR(10) NOT NULL,
    "КПП" VARCHAR(9) NOT NULL,
    "ПолноеНаименование" VARCHAR(200) NOT NULL,
    "СокращённоеНаименование" VARCHAR(100),
    "Адрес" VARCHAR(255),
    "Телефон" VARCHAR(20) CHECK ("Телефон" ~ '^\+7\s*\(\d{3}\)\s*\d{3}-\d{2}-\d{2}$'),
    "Email" VARCHAR(50) CHECK ("Email" ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
    "ФИОКонтакта" VARCHAR(100),
    
    PRIMARY KEY ("ИНН", "КПП"),
    CONSTRAINT chk_inn_kpp UNIQUE ("ИНН", "КПП")
);

-- =====================================================
-- 4. ТАБЛИЦА ПАРТИЙ (ТОВАРНЫЕ ОСТАТКИ)
-- =====================================================
CREATE TABLE "Партии" (
    "РегНомерЛС" VARCHAR(15) NOT NULL,
    "ИНН" VARCHAR(10) NOT NULL,
    "КПП" VARCHAR(9) NOT NULL,
    "НомерСерии" VARCHAR(20) NOT NULL,
    "СрокГодности" DATE NOT NULL CHECK ("СрокГодности" > CURRENT_DATE),
    "ДатаПоступления" DATE NOT NULL DEFAULT CURRENT_DATE,
    "КоличествоВУпаковке" INTEGER NOT NULL CHECK ("КоличествоВУпаковке" > 0),
    "КоличествоУпаковок" INTEGER NOT NULL CHECK ("КоличествоУпаковок" > 0),
    "ЦенаЗакупки" DECIMAL(10,2) NOT NULL CHECK ("ЦенаЗакупки" >= 0),
    "ЦенаПродажи" DECIMAL(10,2) NOT NULL CHECK ("ЦенаПродажи" >= 0),
    "Остаток" INTEGER NOT NULL CHECK ("Остаток" >= 0),
    
    PRIMARY KEY ("РегНомерЛС", "ИНН", "КПП", "НомерСерии"),
    
    -- Внешние ключи
    CONSTRAINT fk_партии_лекарства 
        FOREIGN KEY ("РегНомерЛС") REFERENCES "ЛекарственныеСредства"("РегНомерЛС"),
    CONSTRAINT fk_партии_поставщики 
        FOREIGN KEY ("ИНН", "КПП") REFERENCES "Поставщики"("ИНН", "КПП"),
    
    -- Бизнес-правила
    CONSTRAINT chk_остаток_не_превышает_количество 
        CHECK ("Остаток" <= "КоличествоУпаковок")
);

-- =====================================================
-- 5. СПРАВОЧНИК КЛИЕНТОВ
-- =====================================================
CREATE TABLE "Клиенты" (
    "IDКлиента" SERIAL PRIMARY KEY,
    "НомерКарты" VARCHAR(20) UNIQUE,
    "ФИО" VARCHAR(100) NOT NULL,
    "Телефон" VARCHAR(20),
    "Email" VARCHAR(50),
    "ДатаРегистрации" DATE NOT NULL DEFAULT CURRENT_DATE,
    
    -- Проверка формата телефона
    CONSTRAINT chk_клиент_телефон CHECK ("Телефон" IS NULL OR "Телефон" ~ '^\+7\s*\(\d{3}\)\s*\d{3}-\d{2}-\d{2}$'),
    -- Проверка формата email
    CONSTRAINT chk_клиент_email CHECK ("Email" IS NULL OR "Email" ~ '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$')
);

-- =====================================================
-- 6. ТАБЛИЦА ЧЕКОВ
-- =====================================================
CREATE TABLE "Чеки" (
    "НомерЧека" SERIAL PRIMARY KEY,
    "ДатаВремя" TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "НомерКарты" VARCHAR(20),
    "ИтоговаяСумма" DECIMAL(10,2) NOT NULL DEFAULT 0,
    "IDКлиента" INTEGER,
    
    -- Внешний ключ на клиентов (опциональный)
    CONSTRAINT fk_чеки_клиенты 
        FOREIGN KEY ("IDКлиента") REFERENCES "Клиенты"("IDКлиента"),
    
    -- Проверка формата номера карты
    CONSTRAINT chk_номер_карты CHECK ("НомерКарты" IS NULL OR LENGTH("НомерКарты") <= 20)
);

-- =====================================================
-- 7. ТАБЛИЦА ПОЗИЦИЙ ЧЕКА
-- =====================================================
CREATE TABLE "ПозицииЧека" (
    "НомерЧека" INTEGER NOT NULL,
    "РегНомерЛС" VARCHAR(15) NOT NULL,
    "ИНН" VARCHAR(10) NOT NULL,
    "КПП" VARCHAR(9) NOT NULL,
    "НомерСерии" VARCHAR(20) NOT NULL,
    "КоличествоПродано" INTEGER NOT NULL CHECK ("КоличествоПродано" > 0),
    
    PRIMARY KEY ("НомерЧека", "РегНомерЛС", "ИНН", "КПП", "НомерСерии"),
    
    -- Внешние ключи
    CONSTRAINT fk_позиции_чеки 
        FOREIGN KEY ("НомерЧека") REFERENCES "Чеки"("НомерЧека") ON DELETE CASCADE,
    CONSTRAINT fk_позиции_партии 
        FOREIGN KEY ("РегНомерЛС", "ИНН", "КПП", "НомерСерии") 
        REFERENCES "Партии"("РегНомерЛС", "ИНН", "КПП", "НомерСерии") ON DELETE CASCADE
);

-- =====================================================
-- СОЗДАНИЕ ИНДЕКСОВ ДЛЯ ОПТИМИЗАЦИИ
-- =====================================================

-- Индексы для часто используемых запросов
CREATE INDEX idx_лекарственные_средства_мнн ON "ЛекарственныеСредства"("МНН");
CREATE INDEX idx_лекарственные_средства_рег_номер ON "ЛекарственныеСредства"("РегНомерЛС");

CREATE INDEX idx_партии_рег_номер ON "Партии"("РегНомерЛС");
CREATE INDEX idx_партии_срок_годности ON "Партии"("СрокГодности");
CREATE INDEX idx_партии_остаток ON "Партии"("Остаток");

CREATE INDEX idx_чеки_дата_время ON "Чеки"("ДатаВремя");
CREATE INDEX idx_чеки_номер_карты ON "Чеки"("НомерКарты");

CREATE INDEX idx_клиенты_номер_карты ON "Клиенты"("НомерКарты");

-- Составные индексы для сложных запросов
CREATE INDEX idx_партии_рег_номер_остаток ON "Партии"("РегНомерЛС", "Остаток");
CREATE INDEX idx_чеки_дата_сумма ON "Чеки"("ДатаВремя", "ИтоговаяСумма");

-- =====================================================
-- СОЗДАНИЕ ФУНКЦИЙ И ТРИГГЕРОВ
-- =====================================================

-- Функция для автоматического расчёта итоговой суммы чека
CREATE OR REPLACE FUNCTION calculate_receipt_total()
RETURNS TRIGGER AS $$
BEGIN
    UPDATE "Чеки"
    SET "ИтоговаяСумма" = (
        SELECT COALESCE(SUM("ПозицииЧека"."КоличествоПродано" * "Партии"."ЦенаПродажи"), 0)
        FROM "ПозицииЧека"
        JOIN "Партии" ON (
            "ПозицииЧека"."РегНомерЛС" = "Партии"."РегНомерЛС" AND
            "ПозицииЧека"."ИНН" = "Партии"."ИНН" AND
            "ПозицииЧека"."КПП" = "Партии"."КПП" AND
            "ПозицииЧека"."НомерСерии" = "Партии"."НомерСерии"
        )
        WHERE "ПозицииЧека"."НомерЧека" = NEW."НомерЧека"
    )
    WHERE "НомерЧека" = NEW."НомерЧека";
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Триггер для автоматического расчёта суммы чека
CREATE TRIGGER trigger_calculate_receipt_total
    AFTER INSERT OR UPDATE ON "ПозицииЧека"
    FOR EACH ROW
    EXECUTE FUNCTION calculate_receipt_total();

-- Функция для автоматического обновления остатков при продаже
CREATE OR REPLACE FUNCTION update_stock_after_sale()
RETURNS TRIGGER AS $$
BEGIN
    -- Уменьшаем остаток в партии
    UPDATE "Партии"
    SET "Остаток" = "Остаток" - NEW."КоличествоПродано"
    WHERE ("РегНомерЛС", "ИНН", "КПП", "НомерСерии") = 
          (NEW."РегНомерЛС", NEW."ИНН", NEW."КПП", NEW."НомерСерии");
    
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Триггер для автоматического обновления остатков
CREATE TRIGGER trigger_update_stock
    AFTER INSERT ON "ПозицииЧека"
    FOR EACH ROW
    EXECUTE FUNCTION update_stock_after_sale();

-- =====================================================
-- СОЗДАНИЕ ПРЕДСТАВЛЕНИЙ (VIEW) ДЛЯ ОТЧЁТОВ
-- =====================================================

-- Представление для просмотра текущих остатков
CREATE VIEW "ТекущиеОстатки" AS
SELECT 
    ls."ТорговоеНаименование",
    ls."МНН",
    p."НомерСерии",
    p."СрокГодности",
    p."Остаток",
    p."ЦенаПродажи",
    s."ПолноеНаименование" as "Поставщик"
FROM "Партии" p
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
JOIN "Поставщики" s ON (p."ИНН", p."КПП") = (s."ИНН", s."КПП")
WHERE p."Остаток" > 0 AND p."СрокГодности" > CURRENT_DATE;

-- Представление для анализа продаж
CREATE VIEW "АнализПродаж" AS
SELECT 
    c."НомерЧека",
    c."ДатаВремя",
    ls."ТорговоеНаименование",
    ls."МНН",
    pc."КоличествоПродано",
    p."ЦенаПродажи",
    (pc."КоличествоПродано" * p."ЦенаПродажи") as "СуммаПозиции"
FROM "Чеки" c
JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС";

-- =====================================================
-- СОЗДАНИЕ РОЛЕЙ И ПРАВ ДОСТУПА
-- =====================================================

-- Роль для администратора (полные права)
CREATE ROLE "pharmacy_admin";
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO "pharmacy_admin";
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO "pharmacy_admin";

-- Роль для фармацевта (чтение и запись данных продаж)
CREATE ROLE "pharmacy_cashier";
GRANT SELECT, INSERT, UPDATE ON "Чеки", "ПозицииЧека", "ТекущиеОстатки", "АнализПродаж" TO "pharmacy_cashier";
GRANT UPDATE ON "Партии" TO "pharmacy_cashier";

-- Роль для заведующего (чтение всех данных)
CREATE ROLE "pharmacy_manager";
GRANT SELECT ON ALL TABLES IN SCHEMA public TO "pharmacy_manager";
GRANT SELECT ON ALL VIEWS IN SCHEMA public TO "pharmacy_manager";

-- =====================================================
-- КОММЕНТАРИИ К ТАБЛИЦАМ И СТОЛБЦАМ
-- =====================================================

COMMENT ON TABLE "Страны" IS 'Справочник стран по ОКСМ';
COMMENT ON TABLE "ЛекарственныеСредства" IS 'Справочник лекарственных средств из ГРЛС';
COMMENT ON TABLE "Поставщики" IS 'Справочник поставщиков фармацевтических товаров';
COMMENT ON TABLE "Партии" IS 'Товарные партии с указанием срока годности';
COMMENT ON TABLE "Клиенты" IS 'Справочник клиентов аптеки';
COMMENT ON TABLE "Чеки" IS 'Кассовые чеки';
COMMENT ON TABLE "ПозицииЧека" IS 'Позиции товаров в чеках';

COMMENT ON COLUMN "ЛекарственныеСредства"."РегНомерЛС" IS 'Регистрационный номер в ГРЛС';
COMMENT ON COLUMN "ЛекарственныеСредства"."МНН" IS 'Международное непатентованное наименование';
COMMENT ON COLUMN "ЛекарственныеСредства"."УсловияОтпуска" IS 'Условия отпуска: по рецепту или без рецепта';
COMMENT ON COLUMN "Партии"."Остаток" IS 'Текущий остаток упаковок в партии';
COMMENT ON COLUMN "Чеки"."НомерКарты" IS 'Номер дисконтной карты клиента (опционально)';

-- =====================================================
-- КОНЕЦ СКРИПТА
-- =====================================================
