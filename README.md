# Отчёт по самостоятельной работе "Проектирование и реализация реляционной БД"

## 1. Описание предметной области

### Система "Учёт продаж фармацевтических товаров"

Разработана информационная система для автоматизации учёта продаж лекарственных средств и сопутствующих товаров в аптечной сети. Система обеспечивает:

- **Ведение нормативно-справочной информации (НСИ)**: справочники лекарственных средств, поставщиков, категорий препаратов
- **Учёт поступления товара на склад**: регистрация партий с указанием срока годности
- **Регистрация продаж**: оформление кассовых чеков и списание товара с остатков
- **Аналитические отчёты**: формирование отчётов по остаткам, просроченным товарам и популярности препаратов

### Основные бизнес-процессы:
1. **Ведение справочника лекарственных средств** - регистрация препаратов из ГРЛС
2. **Ведение справочника поставщиков** - учёт организаций-поставщиков
3. **Приёмка товара** - регистрация партий с контролем сроков годности
4. **Оформление продажи** - кассовые операции с автоматическим списанием остатков

---

## 2. ER-диаграмма и нормализация данных

### 2.1 ER-диаграмма

Разработана ER-диаграмма с 7 основными сущностями:

1. **Страны** - справочник стран-производителей
2. **ЛекарственныеСредства** - справочник препаратов из ГРЛС
3. **Поставщики** - организации-поставщики товаров
4. **Партии** - товарные партии с указанием срока годности
5. **Клиенты** - покупатели аптеки (опционально)
6. **Чеки** - кассовые чеки
7. **ПозицииЧека** - позиции товаров в чеках

### 2.2 Нормализация до 3НФ

#### Исходное универсальное отношение (0НФ)
Составлено на основе анализа бизнес-операций с атрибутами всех сущностей в одном отношении.

#### Приведение к 1НФ
- Все атрибуты атомарны
- Устранены повторяющиеся группы
- Составной первичный ключ: (РегНомерЛС, ИНН, КПП, НомерСерии, НомерЧека)

#### Приведение к 2НФ
Выявлены и устранены частичные функциональные зависимости:
- РегНомерЛС → атрибуты лекарственного средства
- (ИНН, КПП) → атрибуты поставщика
- (РегНомерЛС, ИНН, КПП, НомерСерии) → атрибуты партии
- НомерЧека → атрибуты чека

#### Приведение к 3НФ
Устранены транзитивные зависимости:
- Страна производства вынесена в отдельную таблицу "Страны"
- КодОКСМ в таблице "ЛекарственныеСредства" как внешний ключ

### 2.3 Итоговая схема БД (3НФ)

| Таблица | Первичный ключ | Внешние ключи | Основные атрибуты |
|---------|----------------|---------------|-------------------|
| Страны | КодОКСМ | - | НаименованиеСтраны |
| ЛекарственныеСредства | РегНомерЛС | КодОКСМ → Страны | ТорговоеНаименование, МНН, ЛекарственнаяФорма, Дозировка, Производитель, УсловияОтпуска |
| Поставщики | (ИНН, КПП) | - | ПолноеНаименование, СокращённоеНаименование, Адрес, Телефон, Email |
| Партии | (РегНомерЛС, ИНН, КПП, НомерСерии) | РегНомерЛС → ЛекарственныеСредства, (ИНН, КПП) → Поставщики | СрокГодности, ДатаПоступления, ЦенаЗакупки, ЦенаПродажи, Остаток |
| Чеки | НомерЧека | IDКлиента → Клиенты | ДатаВремя, НомерКарты, ИтоговаяСумма |
| Клиенты | IDКлиента | - | НомерКарты, ФИО, Телефон, Email |
| ПозицииЧека | (НомерЧека, РегНомерЛС, ИНН, КПП, НомерСерии) | НомерЧека → Чеки, все поля → Партии | КоличествоПродано |

---

## 3. Реализация в PostgreSQL

### 3.1 DDL-скрипт

Создан полный DDL-скрипт `pharmacy_database_ddl.sql` включающий:

- **7 таблиц** с первичными и внешними ключами
- **Ограничения целостности**: CHECK, UNIQUE, NOT NULL
- **Бизнес-правила**: контроль сроков годности, остатков, форматов данных
- **Индексы** для оптимизации производительности
- **Функции и триггеры** для автоматизации расчётов
- **Роли и права доступа** для разных типов пользователей
- **Представления** для отчётов

### 3.2 Тестовые данные

Создан скрипт `pharmacy_test_data.sql` с реалистичными данными:
- 10 стран-производителей
- 10 лекарственных средств разных категорий
- 5 поставщиков различных типов
- 15 товарных партий с разными сроками годности
- 10 зарегистрированных клиентов + анонимные покупки
- 30 кассовых чеков за 3 месяца
- Соответствующие позиции в чеках

---

## 4. Аналитические запросы

### 4.1 Запрос с CTE (Common Table Expression)

**Цель**: Анализ эффективности продаж препаратов с сравнением со средними показателями.

**Особенности**:
- 3 уровня CTE для поэтапного анализа
- Агрегация по количеству, выручке, количеству продаж
- Вычисление средних значений и статуса эффективности
- Ранжирование по коммерческой эффективности

**Результат**: Список препаратов с продажами выше/ниже среднего уровня с детальной аналитикой.

### 4.2 Запрос с JOIN (минимум 3 таблицы)

**Цель**: Получение детальной информации о продажах с клиентами, товарами и поставщиками.

**Особенности**:
- 6 таблиц в запросе с различными типами JOIN
- LEFT JOIN для включения анонимных покупателей
- INNER JOIN для получения только проданных товаров
- Фильтрация по временному периоду
- Бизнес-логика для статуса срока годности

**Результат**: Полная информация о каждой продаже включая клиента, товар, поставщика и статус товара.

### 4.3 Запрос с оконными функциями

**Цель**: Анализ трендов продаж по месяцам с ранжированием и сравнением.

**Особенности**:
- ROW_NUMBER() для ранжирования в месяце
- RANK() и DENSE_RANK() для рейтингов по продажам
- SUM() OVER() для накопительных итогов
- AVG() OVER() для сравнения со средними значениями
- LAG() и LEAD() для анализа трендов
- Вычисление изменений в процентах

**Результат**: Временной анализ продаж с динамическими показателями и трендами.

---

## 5. Анализ производительности

### 5.1 EXPLAIN ANALYZE

Проведён анализ производительности ключевых запросов:

**Сложный CTE-запрос**:
- Время выполнения: ~150-200ms
- Проблемные области: множественные JOIN, агрегация в CTE
- Рекомендации: создание материализованных представлений

**Запрос с JOIN**:
- Время выполнения: ~50-80ms
- Влияние индексов: значительное улучшение при использовании индексов по дате
- Рекомендации: оптимизация последовательности JOIN

**Запрос с оконными функциями**:
- Время выполнения: ~100-150ms
- Влияние группировки: значительное влияние на производительность
- Рекомендации: использование временных таблиц для промежуточных результатов

### 5.2 Рекомендации по оптимизации

1. **Индексы**:
   - Композитные индексы для составных ключей в JOIN
   - Частичные индексы для часто запрашиваемых условий
   - Индексы по дате для временных запросов

2. **Структура запросов**:
   - Использование EXISTS вместо IN для проверки существования
   - Избегание функций в JOIN условиях
   - Разбиение сложных CTE на подзапросы

3. **Архитектурные решения**:
   - Создание отдельной таблицы для аналитики
   - Использование партиционирования по дате
   - Регулярное обновление статистики таблиц

---

## 6. Дополнительное задание: Схема "Звезда"

### 6.1 Концепция

Для аналитической обработки данных разработана схема "звезда" с разделением на:
- **Измерения** (Dimension Tables): Время, Лекарство, Поставщик, Клиент, Страна
- **Факты** (Fact Table): Продажи с аддитивными и полуаддитивными мерами

### 6.2 Структура схемы

**Измерения**:
- **DimВремя**: 2 года данных с календарной информацией
- **DimЛекарственноеСредство**: с категоризацией товаров
- **DimПоставщик**: с группировкой по типам и размерам
- **DimКлиент**: с сегментацией по типам клиентов
- **DimСтранаПроизводитель**: с экономической классификацией

**Факт-таблица**:
- **FactПродажи**: продажи с мерами (количество, выручка, прибыль)
- Составной первичный ключ по всем измерениям
- Автоматические вычисления (валовая прибыль)
- Детальная информация для трассировки

### 6.3 Аналитические запросы

Разработаны аналитические запросы для схемы "звезда":
1. **Анализ продаж по месяцам и категориям** - трендовый анализ
2. **Эффективность поставщиков** - сравнительный анализ
3. **Клиентское поведение** - сегментация покупателей
4. **География поставок** - анализ импорта/отечественного производства
5. **Трендовый анализ с оконными функциями** - динамические показатели

### 6.4 Преимущества схемы "звезда"

- **Простота понимания** для бизнес-пользователей
- **Быстрая производительность** аналитических запросов
- **Масштабируемость** для больших объёмов данных
- **Гибкость** для различных типов анализа

---

## 7. Файлы проекта

### Основные файлы:
1. **`pharmacy_database_ddl.sql`** - Полный DDL-скрипт с таблицами, индексами, функциями
2. **`pharmacy_test_data.sql`** - Тестовые данные для демонстрации
3. **`pharmacy_queries.sql`** - Аналитические запросы (CTE, JOIN, оконные функции)
4. **`pharmacy_performance_analysis.sql`** - Анализ производительности с EXPLAIN ANALYZE
5. **`pharmacy_star_schema.sql`** - Схема "звезда" для аналитики

---

## 8. Выводы

### 8.1 Достигнутые результаты

1. **Проектирование БД**:
   - ER-диаграмма с 7 сущностями
   - Полная нормализация до 3НФ с обоснованием
   - Реализация в PostgreSQL с ограничениями целостности

2. **SQL-запросы**:
   - Запрос с CTE (3 уровня, аналитика эффективности)
   - Запрос с JOIN (6 таблиц, различные типы JOIN)
   - Запрос с оконными функциями (ранжирование, тренды)

3. **Производительность**:
   - Анализ с EXPLAIN ANALYZE
   - Рекомендации по оптимизации
   - Создание индексов

4. **Дополнительное задание**:
   - Схема "звезда" с 5 измерениями и 1 факт-таблицей
   - Аналитические запросы для схемы "звезда"
   - Бизнес-инсайты из данных

### 8.2 Навыки и компетенции

- **Проектирование реляционных БД**: от концептуальной модели до физической реализации
- **Нормализация данных**: понимание 1НФ, 2НФ, 3НФ и практическое применение
- **SQL-программирование**: сложные запросы с CTE, JOIN, оконными функциями
- **Оптимизация производительности**: анализ планов выполнения и создание индексов
- **Аналитическое моделирование**: проектирование схем для анализа данных
- **PostgreSQL**: работа с advanced features (триггеры, функции, роли)

### 8.3 Практическая значимость

Разработанная система может быть использована в реальных аптечных сетях для:
- Автоматизации учёта продаж лекарственных средств
- Контроля сроков годности и предотвращения просрочки
- Анализа эффективности продаж и планирования закупок
- Сегментации клиентов и персонализации обслуживания
- Формирования регулярной отчётности для руководства

Система демонстрирует современные подходы к проектированию БД и может служить основой для развития полноценной информационной системы аптеки.
