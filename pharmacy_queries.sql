-- =====================================================
-- SQL ЗАПРОСЫ ДЛЯ СИСТЕМЫ "УЧЁТ ПРОДАЖ ФАРМАЦЕВТИЧЕСКИХ ТОВАРОВ"
-- =====================================================

-- =====================================================
-- 1. ЗАПРОС С CTE (Common Table Expression)
-- =====================================================
-- Цель: Найти препараты, которые продаются лучше среднего, с дополнительной аналитикой
WITH ПродажиПоПрепаратам AS (
    -- CTE 1: Суммируем продажи по каждому препарату
    SELECT 
        ls."РегНомерЛС",
        ls."ТорговоеНаименование",
        ls."МНН",
        SUM(pc."КоличествоПродано") as "ОбщееКоличество",
        COUNT(DISTINCT c."НомерЧека") as "КоличествоПродаж",
        AVG(p."ЦенаПродажи") as "СредняяЦена",
        SUM(pc."КоличествоПродано" * p."ЦенаПродажи") as "ОбщаяВыручка"
    FROM "ПозицииЧека" pc
    JOIN "Партии" p ON (
        pc."РегНомерЛС" = p."РегНомерЛС" AND
        pc."ИНН" = p."ИНН" AND
        pc."КПП" = p."КПП" AND
        pc."НомерСерии" = p."НомерСерии"
    )
    JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
    JOIN "Чеки" c ON pc."НомерЧека" = c."НомерЧека"
    GROUP BY ls."РегНомерЛС", ls."ТорговоеНаименование", ls."МНН"
),
СредниеПродажи AS (
    -- CTE 2: Рассчитываем средние показатели по всем препаратам
    SELECT 
        AVG("ОбщееКоличество") as "СреднееКоличество",
        AVG("ОбщаяВыручка") as "СредняяВыручка"
    FROM ПродажиПоПрепаратам
),
ПрепаратыВышеСреднего AS (
    -- CTE 3: Отбираем препараты с продажами выше среднего
    SELECT 
        пп.*,
        CASE 
            WHEN пп."ОбщееКоличество" > сп."СреднееКоличество" THEN 'Выше среднего'
            ELSE 'Ниже среднего'
        END as "СтатусПродаж"
    FROM ПродажиПоПрепаратам пп
    CROSS JOIN СредниеПродажи сп
)
-- Основной запрос с использованием CTE
SELECT 
    "ТорговоеНаименование",
    "МНН",
    "ОбщееКоличество",
    "КоличествоПродаж",
    ROUND("СредняяЦена", 2) as "СредняяЦена",
    ROUND("ОбщаяВыручка", 2) as "ОбщаяВыручка",
    "СтатусПродаж",
    -- Дополнительная аналитика: эффективность продаж
    CASE 
        WHEN "КоличествоПродаж" > 0 THEN ROUND("ОбщееКоличество"::DECIMAL / "КоличествоПродаж", 2)
        ELSE 0 
    END as "СреднееКоличествоЗаПродажу"
FROM ПрепаратыВышеСреднего
WHERE "ОбщееКоличество" > 0
ORDER BY "ОбщаяВыручка" DESC;

-- =====================================================
-- 2. ЗАПРОС С JOIN (минимум 3 таблицы)
-- =====================================================
-- Цель: Получить детальную информацию о продажах с клиентами, товарами и поставщиками
SELECT 
    c."НомерЧека",
    c."ДатаВремя",
    
    -- Информация о клиенте
    COALESCE(k."ФИО", 'Анонимный покупатель') as "Клиент",
    COALESCE(k."НомерКарты", 'Не зарегистрирован') as "Карта",
    
    -- Информация о товаре
    ls."ТорговоеНаименование",
    ls."МНН",
    ls."ЛекарственнаяФорма",
    ls."Дозировка",
    ls."УсловияОтпуска",
    
    -- Информация о партии
    p."НомерСерии",
    p."СрокГодности",
    p."ЦенаПродажи",
    
    -- Информация о поставщике
    s."СокращённоеНаименование" as "Поставщик",
    s."Телефон" as "ТелефонПоставщика",
    
    -- Информация о продаже
    pc."КоличествоПродано",
    (pc."КоличествоПродано" * p."ЦенаПродажи") as "СуммаПозиции",
    
    -- Дополнительные показатели
    CASE 
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '30 days' THEN 'Скоро истекает'
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '90 days' THEN 'Внимание'
        ELSE 'Нормальный срок'
    END as "СтатусСрокаГодности"
    
FROM "Чеки" c
-- LEFT JOIN для включения анонимных покупателей
LEFT JOIN "Клиенты" k ON c."IDКлиента" = k."IDКлиента"
-- INNER JOIN для получения только проданных товаров
INNER JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
INNER JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
INNER JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
INNER JOIN "Поставщики" s ON (p."ИНН", p."КПП") = (s."ИНН", s."КПП")
WHERE c."ДатаВремя" >= '2025-01-01'::DATE
ORDER BY c."ДатаВремя" DESC, c."НомерЧека", ls."ТорговоеНаименование";

-- =====================================================
-- 3. ЗАПРОС С ОКОННЫМИ ФУНКЦИЯМИ
-- =====================================================
-- Цель: Проанализировать продажи с ранжированием и трендами
SELECT 
    -- Базовые данные о продажах
    ls."ТорговоеНаименование",
    ls."МНН",
    DATE_TRUNC('month', c."ДатаВремя") as "МесяцПродажи",
    
    -- Оконные функции для ранжирования
    ROW_NUMBER() OVER (PARTITION BY DATE_TRUNC('month', c."ДатаВремя") ORDER BY SUM(pc."КоличествоПродано") DESC) as "РангВМесяце",
    RANK() OVER (ORDER BY SUM(pc."КоличествоПродано") DESC) as "ОбщийРангПоПродажам",
    DENSE_RANK() OVER (PARTITION BY ls."МНН" ORDER BY SUM(pc."КоличествоПродано") DESC) as "РангПоМНН",
    
    -- Оконные функции для агрегации
    SUM(pc."КоличествоПродано") OVER (PARTITION BY ls."РегНомерЛС") as "ОбщиеПродажиПрепарата",
    SUM(pc."КоличествоПродано" * p."ЦенаПродажи") OVER (PARTITION BY ls."РегНомерЛС") as "ОбщаяВыручкаПрепарата",
    
    -- Оконные функции для сравнения
    AVG(p."ЦенаПродажи") OVER (PARTITION BY ls."МНН") as "СредняяЦенаПоМНН",
    
    -- Функции для анализа трендов
    LAG(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя")) as "ПродажиПредыдущегоМесяца",
    LEAD(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя")) as "ПродажиСледующегоМесяца",
    
    -- Расчёт изменений
    CASE 
        WHEN LAG(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя")) IS NOT NULL 
        THEN ROUND(
            ((SUM(pc."КоличествоПродано") - LAG(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя"))) * 100.0) / 
            LAG(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя")), 2
        )
        ELSE NULL 
    END as "ИзменениеПроцентов",
    
    -- Текущие значения
    SUM(pc."КоличествоПродано") as "ПродажиЗаМесяц",
    COUNT(DISTINCT c."НомерЧека") as "КоличествоПродажЗаМесяц",
    ROUND(AVG(p."ЦенаПродажи"), 2) as "СредняяЦенаЗаМесяц"
    
FROM "ПозицииЧека" pc
JOIN "Чеки" c ON pc."НомерЧека" = c."НомерЧека"
JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
GROUP BY 
    ls."РегНомерЛС", 
    ls."ТорговоеНаименование", 
    ls."МНН",
    DATE_TRUNC('month', c."ДатаВремя"),
    p."ЦенаПродажи"
ORDER BY "МесяцПродажи" DESC, "ОбщиеПродажиПрепарата" DESC, "РангВМесяце";

-- =====================================================
-- 4. ДОПОЛНИТЕЛЬНЫЕ ЗАПРОСЫ ДЛЯ АНАЛИТИКИ
-- =====================================================

-- Запрос для анализа клиентской активности с CTE
WITH АктивностьКлиентов AS (
    SELECT 
        k."IDКлиента",
        k."ФИО",
        k."НомерКарты",
        COUNT(c."НомерЧека") as "КоличествоПокупок",
        SUM(c."ИтоговаяСумма") as "ОбщаяСуммаПокупок",
        AVG(c."ИтоговаяСумма") as "СреднийЧек",
        MIN(c."ДатаВремя") as "ПерваяПокупка",
        MAX(c."ДатаВремя") as "ПоследняяПокупка",
        DATE_PART('day', MAX(c."ДатаВремя") - MIN(c."ДатаВремя")) as "ПериодАктивностиДней"
    FROM "Клиенты" k
    JOIN "Чеки" c ON k."IDКлиента" = c."IDКлиента"
    GROUP BY k."IDКлиента", k."ФИО", k."НомерКарты"
),
СегментацияКлиентов AS (
    SELECT 
        ac.*,
        CASE 
            WHEN "ОбщаяСуммаПокупок" >= 2000 THEN 'VIP клиент'
            WHEN "ОбщаяСуммаПокупок" >= 1000 THEN 'Активный клиент'
            WHEN "ОбщаяСуммаПокупок" >= 500 THEN 'Регулярный клиент'
            WHEN "ОбщаяСуммаПокупок" > 0 THEN 'Новый клиент'
            ELSE 'Неактивный'
        END as "Сегмент",
        CASE 
            WHEN "ПериодАктивностиДней" > 0 THEN 
                ROUND("КоличествоПокупок"::DECIMAL / "ПериодАктивностиДней" * 30, 2)
            ELSE 0 
        END as "ЧастотаПокупокВМесяц"
    FROM АктивностьКлиентов ac
)
SELECT 
    "ФИО",
    "НомерКарты",
    "Сегмент",
    "КоличествоПокупок",
    ROUND("ОбщаяСуммаПокупок", 2) as "ОбщаяСумма",
    ROUND("СреднийЧек", 2) as "СреднийЧек",
    ROUND("ЧастотаПокупокВМесяц", 2) as "ЧастотаВМесяц",
    "ПерваяПокупка",
    "ПоследняяПокупка"
FROM СегментацияКлиентов
WHERE "КоличествоПокупок" > 0
ORDER BY "ОбщаяСуммаПокупок" DESC;

-- =====================================================
-- ЗАПРОС ДЛЯ АНАЛИЗА ПРОСРОЧЕННЫХ ТОВАРОВ
-- =====================================================
SELECT 
    ls."ТорговоеНаименование",
    ls."МНН",
    p."НомерСерии",
    p."ДатаПоступления",
    p."СрокГодности",
    CURRENT_DATE as "ТекущаяДата",
    p."СрокГодности" - CURRENT_DATE as "ДнейДоИстечения",
    p."Остаток",
    p."ЦенаПродажи",
    (p."Остаток" * p."ЦенаПродажи") as "СтоимостьОстатка",
    
    -- Оконная функция для определения критичности
    CASE 
        WHEN p."СрокГодности" < CURRENT_DATE THEN 'ПРОСРОЧЕН'
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '7 days' THEN 'КРИТИЧНО'
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '30 days' THEN 'ВНИМАНИЕ'
        ELSE 'НОРМАЛЬНО'
    END as "СтатусТовара",
    
    -- Ранжирование по критичности
    ROW_NUMBER() OVER (ORDER BY p."СрокГодности") as "ПриоритетСписания"
    
FROM "Партии" p
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
WHERE p."Остаток" > 0
ORDER BY 
    CASE 
        WHEN p."СрокГодности" < CURRENT_DATE THEN 1
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '7 days' THEN 2
        WHEN p."СрокГодности" <= CURRENT_DATE + INTERVAL '30 days' THEN 3
        ELSE 4
    END,
    p."СрокГодности";
