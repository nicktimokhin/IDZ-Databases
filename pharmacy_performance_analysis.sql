-- =====================================================
-- 1. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ СЛОЖНОГО ЗАПРОСА С CTE
-- =====================================================

-- Запрос для анализа производительности
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
WITH ПродажиПоПрепаратам AS (
    SELECT 
        ls."РегНомерЛС",
        ls."ТорговоеНаименование",
        ls."МНН",
        SUM(pc."КоличествоПродано") as "ОбщееКоличество",
        COUNT(DISTINCT c."НомерЧека") as "КоличествоПродаж",
        AVG(p."ЦенаПродажи") as "СредняяЦена",
        SUM(pc."КоличествоПродано" * p."ЦенаПродажи") as "ОбщаяВыручка"
    FROM "ПозицииЧека" pc
    JOIN "Партии" p ON (
        pc."РегНомерЛС" = p."РегНомерЛС" AND
        pc."ИНН" = p."ИНН" AND
        pc."КПП" = p."КПП" AND
        pc."НомерСерии" = p."НомерСерии"
    )
    JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
    JOIN "Чеки" c ON pc."НомерЧека" = c."НомерЧека"
    GROUP BY ls."РегНомерЛС", ls."ТорговоеНаименование", ls."МНН"
),
СредниеПродажи AS (
    SELECT 
        AVG("ОбщееКоличество") as "СреднееКоличество",
        AVG("ОбщаяВыручка") as "СредняяВыручка"
    FROM ПродажиПоПрепаратам
),
ПрепаратыВышеСреднего AS (
    SELECT 
        пп.*,
        CASE 
            WHEN пп."ОбщееКоличество" > сп."СреднееКоличество" THEN 'Выше среднего'
            ELSE 'Ниже среднего'
        END as "СтатусПродаж"
    FROM ПродажиПоПрепаратам пп
    CROSS JOIN СредниеПродажи сп
)
SELECT 
    "ТорговоеНаименование",
    "МНН",
    "ОбщееКоличество",
    "КоличествоПродаж",
    ROUND("СредняяЦена", 2) as "СредняяЦена",
    ROUND("ОбщаяВыручка", 2) as "ОбщаяВыручка",
    "СтатусПродаж"
FROM ПрепаратыВышеСреднего
WHERE "ОбщееКоличество" > 0
ORDER BY "ОбщаяВыручка" DESC
LIMIT 10;

-- =====================================================
-- 2. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ ЗАПРОСА С JOIN
-- =====================================================

EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
SELECT 
    c."НомерЧека",
    c."ДатаВремя",
    COALESCE(k."ФИО", 'Анонимный покупатель') as "Клиент",
    ls."ТорговоеНаименование",
    ls."МНН",
    pc."КоличествоПродано",
    p."ЦенаПродажи",
    s."СокращённоеНаименование" as "Поставщик"
FROM "Чеки" c
LEFT JOIN "Клиенты" k ON c."IDКлиента" = k."IDКлиента"
INNER JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
INNER JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
INNER JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
INNER JOIN "Поставщики" s ON (p."ИНН", p."КПП") = (s."ИНН", s."КПП")
WHERE c."ДатаВремя" >= '2025-01-01'::DATE
ORDER BY c."ДатаВремя" DESC, c."НомерЧека"
LIMIT 50;

-- =====================================================
-- 3. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ ЗАПРОСА С ОКОННЫМИ ФУНКЦИЯМИ
-- =====================================================

EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
SELECT 
    ls."ТорговоеНаименование",
    ls."МНН",
    DATE_TRUNC('month', c."ДатаВремя") as "МесяцПродажи",
    ROW_NUMBER() OVER (PARTITION BY DATE_TRUNC('month', c."ДатаВремя") ORDER BY SUM(pc."КоличествоПродано") DESC) as "РангВМесяце",
    SUM(pc."КоличествоПродано") OVER (PARTITION BY ls."РегНомерЛС") as "ОбщиеПродажиПрепарата",
    AVG(p."ЦенаПродажи") OVER (PARTITION BY ls."МНН") as "СредняяЦенаПоМНН",
    LAG(SUM(pc."КоличествоПродано")) OVER (PARTITION BY ls."РегНомерЛС" ORDER BY DATE_TRUNC('month', c."ДатаВремя")) as "ПродажиПредыдущегоМесяца",
    SUM(pc."КоличествоПродано") as "ПродажиЗаМесяц"
FROM "ПозицииЧека" pc
JOIN "Чеки" c ON pc."НомерЧека" = c."НомерЧека"
JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
GROUP BY 
    ls."РегНомерЛС", 
    ls."ТорговоеНаименование", 
    ls."МНН",
    DATE_TRUNC('month', c."ДатаВремя"),
    p."ЦенаПродажи"
ORDER BY "МесяцПродажи" DESC
LIMIT 20;

-- =====================================================
-- 4. АНАЛИЗ ВЛИЯНИЯ ИНДЕКСОВ НА ПРОИЗВОДИТЕЛЬНОСТЬ
-- =====================================================

-- Сначала удалим индексы для сравнения
DROP INDEX IF EXISTS idx_лекарственные_средства_мнн;
DROP INDEX IF EXISTS idx_партии_рег_номер;
DROP INDEX IF EXISTS idx_чеки_дата_время;

-- Выполним запрос без индексов
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
SELECT 
    ls."ТорговоеНаименование",
    ls."МНН",
    COUNT(pc."НомерЧека") as "КоличествоПродаж",
    SUM(pc."КоличествоПродано") as "ОбщееКоличество"
FROM "ЛекарственныеСредства" ls
JOIN "Партии" p ON ls."РегНомерЛС" = p."РегНомерЛС"
JOIN "ПозицииЧека" pc ON (
    p."РегНомерЛС" = pc."РегНомерЛС" AND
    p."ИНН" = pc."ИНН" AND
    p."КПП" = pc."КПП" AND
    p."НомерСерии" = pc."НомерСерии"
)
WHERE ls."МНН" = 'Парацетамол'
GROUP BY ls."РегНомерЛС", ls."ТорговоеНаименование", ls."МНН";

-- Восстановим индексы
CREATE INDEX idx_лекарственные_средства_мнн ON "ЛекарственныеСредства"("МНН");
CREATE INDEX idx_партии_рег_номер ON "Партии"("РегНомерЛС");
CREATE INDEX idx_чеки_дата_время ON "Чеки"("ДатаВремя");

-- Выполним тот же запрос с индексами
EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
SELECT 
    ls."ТорговоеНаименование",
    ls."МНН",
    COUNT(pc."НомерЧека") as "КоличествоПродаж",
    SUM(pc."КоличествоПродано") as "ОбщееКоличество"
FROM "ЛекарственныеСредства" ls
JOIN "Партии" p ON ls."РегНомерЛС" = p."РегНомерЛС"
JOIN "ПозицииЧека" pc ON (
    p."РегНомерЛС" = pc."РегНомерЛС" AND
    p."ИНН" = pc."ИНН" AND
    p."КПП" = pc."КПП" AND
    p."НомерСерии" = pc."НомерСерии"
)
WHERE ls."МНН" = 'Парацетамол'
GROUP BY ls."РегНомерЛС", ls."ТорговоеНаименование", ls."МНН";

-- =====================================================
-- 5. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ СЛОЖНОГО АНАЛИТИЧЕСКОГО ЗАПРОСА
-- =====================================================

EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
WITH АнализПродаж AS (
    SELECT 
        c."НомерЧека",
        c."ДатаВремя",
        k."ФИО",
        ls."ТорговоеНаименование",
        ls."МНН",
        pc."КоличествоПродано",
        p."ЦенаПродажи",
        s."ПолноеНаименование" as "Поставщик",
        (pc."КоличествоПродано" * p."ЦенаПродажи") as "СуммаПозиции"
    FROM "Чеки" c
    LEFT JOIN "Клиенты" k ON c."IDКлиента" = k."IDКлиента"
    JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
    JOIN "Партии" p ON (
        pc."РегНомерЛС" = p."РегНомерЛС" AND
        pc."ИНН" = p."ИНН" AND
        pc."КПП" = p."КПП" AND
        pc."НомерСерии" = p."НомерСерии"
    )
    JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
    JOIN "Поставщики" s ON (p."ИНН", p."КПП") = (s."ИНН", s."КПП")
    WHERE c."ДатаВремя" >= '2025-01-01'::DATE
),
СтатистикаПоМНН AS (
    SELECT 
        "МНН",
        COUNT(DISTINCT "НомерЧека") as "КоличествоУникальныхЧеков",
        SUM("КоличествоПродано") as "ОбщееКоличество",
        SUM("СуммаПозиции") as "ОбщаяВыручка",
        AVG("ЦенаПродажи") as "СредняяЦена",
        MIN("ДатаВремя") as "ПерваяПродажа",
        MAX("ДатаВремя") as "ПоследняяПродажа"
    FROM АнализПродаж
    GROUP BY "МНН"
)
SELECT 
    spm."МНН",
    spm."КоличествоУникальныхЧеков",
    spm."ОбщееКоличество",
    ROUND(spm."ОбщаяВыручка", 2) as "ОбщаяВыручка",
    ROUND(spm."СредняяЦена", 2) as "СредняяЦена",
    spm."ПерваяПродажа",
    spm."ПоследняяПродажа",
    DATE_PART('day', spm."ПоследняяПродажа" - spm."ПерваяПродажа") as "ПериодПродажДней",
    ROUND(spm."ОбщаяВыручка" / NULLIF(spm."КоличествоУникальныхЧеков", 0), 2) as "СредняяВыручкаНаЧек"
FROM СтатистикаПоМНН spm
ORDER BY spm."ОбщаяВыручка" DESC;

-- =====================================================
-- 6. АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ ЗАПРОСА С ПАРАМЕТРАМИ
-- =====================================================

-- Создадим функцию для тестирования производительности
CREATE OR REPLACE FUNCTION analyze_query_performance(
    start_date_param DATE,
    end_date_param DATE
) RETURNS TABLE (
    query_plan TEXT,
    execution_time_ms DOUBLE PRECISION,
    total_cost DOUBLE PRECISION,
    rows_returned BIGINT
) AS $$
BEGIN
    RETURN QUERY
    EXPLAIN (ANALYZE, BUFFERS, FORMAT TEXT)
    SELECT 
        c."НомерЧека",
        c."ДатаВремя",
        ls."ТорговоеНаименование",
        pc."КоличествоПродано",
        p."ЦенаПродажи"
    FROM "Чеки" c
    JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
    JOIN "Партии" p ON (
        pc."РегНомерЛС" = p."РегНомерЛС" AND
        pc."ИНН" = p."ИНН" AND
        pc."КПП" = p."КПП" AND
        pc."НомерСерии" = p."НомерСерии"
    )
    JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
    WHERE c."ДатаВремя" BETWEEN start_date_param AND end_date_param
    ORDER BY c."ДатаВремя";
END;
$$ LANGUAGE plpgsql;

-- Тестируем производительность с разными периодами
SELECT analyze_query_performance('2025-01-01'::DATE, '2025-01-31'::DATE);

-- =====================================================
-- РЕКОМЕНДАЦИИ ПО ОПТИМИЗАЦИИ
-- =====================================================

/*
АНАЛИЗ ПРОИЗВОДИТЕЛЬНОСТИ И РЕКОМЕНДАЦИИ ПО ОПТИМИЗАЦИИ:

ПРОБЛЕМНЫЕ ОБЛАСТИ:
   - Сложные JOIN с составными ключами (4 поля)
   - Агрегация в CTE на больших объемах данных
   - Оконные функции на группировках
   - Функции DATE_TRUNC в JOIN условиях

РЕКОМЕНДУЕМЫЕ ИНДЕКСЫ:
   - Композитные индексы для составных ключей в JOIN
   - Индексы по дате для временных запросов
   - Частичные индексы для часто запрашиваемых условий
   - Индексы по полям фильтрации в WHERE

ОПТИМИЗАЦИЯ ЗАПРОСОВ:
   - Использовать EXISTS вместо IN для проверки существования
   - Избегать функций в JOIN условиях
   - Разбивать сложные CTE на подзапросы
   - Использовать материализованные представления для аналитики

АРХИТЕКТУРНЫЕ РЕШЕНИЯ:
   - Создать отдельную таблицу для аналитики
   - Использовать партиционирование по дате
   - Регулярно обновлять статистику таблиц
   - Мониторить размер таблиц и индексов

МОНИТОРИНГ:
   - Включить log_statement для отслеживания медленных запросов
   - Использовать pg_stat_statements для анализа паттернов
   - Регулярно выполнять VACUUM ANALYZE
   - Отслеживать использование кэша буферов
*/
