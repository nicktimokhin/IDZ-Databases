-- =====================================================
-- СХЕМА "ЗВЕЗДА" ДЛЯ АНАЛИТИКИ ПРОДАЖ ФАРМАЦЕВТИЧЕСКИХ ТОВАРОВ
-- =====================================================

-- =====================================================
-- 1. СОЗДАНИЕ ИЗМЕРЕНИЙ (DIMENSION TABLES)
-- =====================================================

-- Измерение "Время"
CREATE TABLE "DimВремя" (
    "КлючВремя" INTEGER PRIMARY KEY,  -- YYYYMMDD
    "Дата" DATE NOT NULL,
    "Год" INTEGER NOT NULL,
    "Месяц" INTEGER NOT NULL,
    "День" INTEGER NOT NULL,
    "Квартал" INTEGER NOT NULL,
    "ДеньНедели" INTEGER NOT NULL,  -- 1=Понедельник, 7=Воскресенье
    "НазваниеМесяца" VARCHAR(20) NOT NULL,
    "НазваниеДняНедели" VARCHAR(15) NOT NULL,
    "ЭтоВыходной" BOOLEAN NOT NULL,
    "ЭтоПраздник" BOOLEAN DEFAULT FALSE
);

-- Измерение "ЛекарственноеСредство"
CREATE TABLE "DimЛекарственноеСредство" (
    "КлючЛекарство" SERIAL PRIMARY KEY,
    "РегНомерЛС" VARCHAR(15) NOT NULL,
    "ТорговоеНаименование" VARCHAR(100) NOT NULL,
    "МНН" VARCHAR(50) NOT NULL,
    "ЛекарственнаяФорма" VARCHAR(30),
    "Дозировка" VARCHAR(20),
    "Производитель" VARCHAR(100),
    "УсловияОтпуска" VARCHAR(20) NOT NULL,
    "КатегорияТовара" VARCHAR(50),  -- Анальгетики, Антибиотики, Витамины, etc.
    "ЭтоРецептурный" BOOLEAN NOT NULL,
    "УникальныйКод" VARCHAR(20) GENERATED ALWAYS AS (
        CONCAT("РегНомерЛС", '_', "МНН")
    ) STORED
);

-- Измерение "Поставщик"
CREATE TABLE "DimПоставщик" (
    "КлючПоставщик" SERIAL PRIMARY KEY,
    "ИНН" VARCHAR(10) NOT NULL,
    "КПП" VARCHAR(9) NOT NULL,
    "ПолноеНаименование" VARCHAR(200) NOT NULL,
    "СокращённоеНаименование" VARCHAR(100),
    "Адрес" VARCHAR(255),
    "Регион" VARCHAR(50),  -- Москва, СПб, Регион
    "ТипОрганизации" VARCHAR(20),  -- ООО, АО, ИП
    "РазмерКомпании" VARCHAR(20),  -- Крупная, Средняя, Малая
    "ГруппаПоставщика" VARCHAR(30)  -- Основной, Дополнительный, Резервный
);

-- Измерение "Клиент"
CREATE TABLE "DimКлиент" (
    "КлючКлиент" SERIAL PRIMARY KEY,
    "НомерКарты" VARCHAR(20),
    "ФИО" VARCHAR(100),
    "ВозрастнаяГруппа" VARCHAR(20),  -- Дети, Взрослые, Пожилые
    "Пол" VARCHAR(10),  -- Мужской, Женский
    "Регион" VARCHAR(50),
    "ТипКлиента" VARCHAR(30),  -- VIP, Регулярный, Новый, Анонимный
    "СтатусАктивности" VARCHAR(20),  -- Активный, Неактивный, Новый
    "ДатаРегистрации" DATE,
    "КоличествоПокупок" INTEGER DEFAULT 0,
    "ОбщаяСуммаПокупок" DECIMAL(12,2) DEFAULT 0
);

-- Измерение "СтранаПроизводитель"
CREATE TABLE "DimСтранаПроизводитель" (
    "КлючСтрана" SERIAL PRIMARY KEY,
    "КодОКСМ" INTEGER,
    "НаименованиеСтраны" VARCHAR(100) NOT NULL,
    "Континент" VARCHAR(30),
    "ЭкономическийРегион" VARCHAR(30),  -- СНГ, ЕС, США, etc.
    "УровеньРазвития" VARCHAR(20),  -- Развитая, Развивающаяся
    "ГруппаПоПроисхождению" VARCHAR(30)  -- Импорт, Отечественный
);

-- =====================================================
-- 2. СОЗДАНИЕ ФАКТ-ТАБЛИЦЫ
-- =====================================================

-- Факт-таблица "Продажи"
CREATE TABLE "FactПродажи" (
    "КлючВремя" INTEGER NOT NULL,
    "КлючЛекарство" INTEGER NOT NULL,
    "КлючПоставщик" INTEGER NOT NULL,
    "КлючКлиент" INTEGER,
    "КлючСтрана" INTEGER NOT NULL,
    
    -- Меры (аддитивные)
    "КоличествоПродано" INTEGER NOT NULL CHECK ("КоличествоПродано" >= 0),
    "Выручка" DECIMAL(12,2) NOT NULL CHECK ("Выручка" >= 0),
    "Себестоимость" DECIMAL(12,2) NOT NULL CHECK ("Себестоимость" >= 0),
    "ВаловаяПрибыль" DECIMAL(12,2) GENERATED ALWAYS AS ("Выручка" - "Себестоимость") STORED,
    
    -- Полуаддитивные меры
    "ОстатокНаНачало" INTEGER DEFAULT 0,
    "ОстатокНаКонец" INTEGER DEFAULT 0,
    
    -- Детальная информация
    "НомерЧека" INTEGER NOT NULL,
    "НомерСерии" VARCHAR(20),
    "СрокГодности" DATE,
    "ЦенаПродажи" DECIMAL(10,2),
    "ЦенаЗакупки" DECIMAL(10,2),
    
    -- Составной первичный ключ
    PRIMARY KEY ("КлючВремя", "КлючЛекарство", "КлючПоставщик", "КлючКлиент", "НомерЧека"),
    
    -- Внешние ключи
    CONSTRAINT fk_fact_время FOREIGN KEY ("КлючВремя") REFERENCES "DimВремя"("КлючВремя"),
    CONSTRAINT fk_fact_лекарство FOREIGN KEY ("КлючЛекарство") REFERENCES "DimЛекарственноеСредство"("КлючЛекарство"),
    CONSTRAINT fk_fact_поставщик FOREIGN KEY ("КлючПоставщик") REFERENCES "DimПоставщик"("КлючПоставщик"),
    CONSTRAINT fk_fact_клиент FOREIGN KEY ("КлючКлиент") REFERENCES "DimКлиент"("КлючКлиент"),
    CONSTRAINT fk_fact_страна FOREIGN KEY ("КлючСтрана") REFERENCES "DimСтранаПроизводитель"("КлючСтрана")
);

-- =====================================================
-- 3. СОЗДАНИЕ ИНДЕКСОВ ДЛЯ СХЕМЫ ЗВЕЗДА
-- =====================================================

-- Индексы для измерений
CREATE INDEX idx_dim_время_дата ON "DimВремя"("Дата");
CREATE INDEX idx_dim_время_год_месяц ON "DimВремя"("Год", "Месяц");
CREATE INDEX idx_dim_время_день ON "DimВремя"("ДеньНедели");

CREATE INDEX idx_dim_лекарство_мнн ON "DimЛекарственноеСредство"("МНН");
CREATE INDEX idx_dim_лекарство_категория ON "DimЛекарственноеСредство"("КатегорияТовара");
CREATE INDEX idx_dim_лекарство_рецептурный ON "DimЛекарственноеСредство"("ЭтоРецептурный");

CREATE INDEX idx_dim_поставщик_инн ON "DimПоставщик"("ИНН", "КПП");
CREATE INDEX idx_dim_поставщик_регион ON "DimПоставщик"("Регион");
CREATE INDEX idx_dim_поставщик_группа ON "DimПоставщик"("ГруппаПоставщика");

CREATE INDEX idx_dim_клиент_карта ON "DimКлиент"("НомерКарты");
CREATE INDEX idx_dim_клиент_тип ON "DimКлиент"("ТипКлиента");
CREATE INDEX idx_dim_клиент_активность ON "DimКлиент"("СтатусАктивности");

CREATE INDEX idx_dim_страна_код ON "DimСтранаПроизводитель"("КодОКСМ");
CREATE INDEX idx_dim_страна_группа ON "DimСтранаПроизводитель"("ГруппаПоПроисхождению");

-- Индексы для факт-таблицы (важны для аналитических запросов)
CREATE INDEX idx_fact_продажи_время ON "FactПродажи"("КлючВремя");
CREATE INDEX idx_fact_продажи_лекарство ON "FactПродажи"("КлючЛекарство");
CREATE INDEX idx_fact_продажи_поставщик ON "FactПродажи"("КлючПоставщик");
CREATE INDEX idx_fact_продажи_клиент ON "FactПродажи"("КлючКлиент");
CREATE INDEX idx_fact_продажи_страна ON "FactПродажи"("КлючСтрана");

-- Составные индексы для частых комбинаций
CREATE INDEX idx_fact_время_лекарство ON "FactПродажи"("КлючВремя", "КлючЛекарство");
CREATE INDEX idx_fact_время_клиент ON "FactПродажи"("КлючВремя", "КлючКлиент");
CREATE INDEX idx_fact_лекарство_поставщик ON "FactПродажи"("КлючЛекарство", "КлючПоставщик");

-- =====================================================
-- 4. ЗАГРУЗКА ДАННЫХ В ИЗМЕРЕНИЯ
-- =====================================================

-- Загрузка измерения "Время" (на 2 года)
INSERT INTO "DimВремя" (
    "КлючВремя", "Дата", "Год", "Месяц", "День", "Квартал", 
    "ДеньНедели", "НазваниеМесяца", "НазваниеДняНедели", "ЭтоВыходной"
)
SELECT 
    EXTRACT(YEAR FROM generate_series)::INTEGER * 10000 + 
    EXTRACT(MONTH FROM generate_series)::INTEGER * 100 + 
    EXTRACT(DAY FROM generate_series)::INTEGER as "КлючВремя",
    generate_series::DATE as "Дата",
    EXTRACT(YEAR FROM generate_series)::INTEGER as "Год",
    EXTRACT(MONTH FROM generate_series)::INTEGER as "Месяц",
    EXTRACT(DAY FROM generate_series)::INTEGER as "День",
    CASE 
        WHEN EXTRACT(MONTH FROM generate_series) BETWEEN 1 AND 3 THEN 1
        WHEN EXTRACT(MONTH FROM generate_series) BETWEEN 4 AND 6 THEN 2
        WHEN EXTRACT(MONTH FROM generate_series) BETWEEN 7 AND 9 THEN 3
        ELSE 4
    END as "Квартал",
    EXTRACT(DOW FROM generate_series)::INTEGER + 1 as "ДеньНедели",
    TO_CHAR(generate_series, 'Month') as "НазваниеМесяца",
    TO_CHAR(generate_series, 'Day') as "НазваниеДняНедели",
    CASE WHEN EXTRACT(DOW FROM generate_series) IN (0, 6) THEN TRUE ELSE FALSE END as "ЭтоВыходной"
FROM generate_series('2024-01-01'::DATE, '2025-12-31'::DATE, '1 day');

-- Загрузка измерения "ЛекарственноеСредство"
INSERT INTO "DimЛекарственноеСредство" (
    "РегНомерЛС", "ТорговоеНаименование", "МНН", "ЛекарственнаяФорма", 
    "Дозировка", "Производитель", "УсловияОтпуска", "КатегорияТовара", "ЭтоРецептурный"
)
SELECT DISTINCT
    ls."РегНомерЛС",
    ls."ТорговоеНаименование",
    ls."МНН",
    ls."ЛекарственнаяФорма",
    ls."Дозировка",
    ls."Производитель",
    ls."УсловияОтпуска",
    CASE 
        WHEN ls."МНН" ILIKE '%парацетамол%' OR ls."МНН" ILIKE '%ибупрофен%' OR ls."МНН" ILIKE '%аспирин%' THEN 'Анальгетики'
        WHEN ls."МНН" ILIKE '%амоксициллин%' OR ls."МНН" ILIKE '%ципрофлоксацин%' THEN 'Антибиотики'
        WHEN ls."МНН" ILIKE '%витамин%' THEN 'Витамины'
        WHEN ls."МНН" ILIKE '%лизиноприл%' THEN 'Кардиологические'
        WHEN ls."МНН" ILIKE '%магний%' THEN 'Минеральные добавки'
        ELSE 'Прочие'
    END as "КатегорияТовара",
    CASE WHEN ls."УсловияОтпуска" = 'по рецепту' THEN TRUE ELSE FALSE END as "ЭтоРецептурный"
FROM "ЛекарственныеСредства" ls;

-- Загрузка измерения "Поставщик"
INSERT INTO "DimПоставщик" (
    "ИНН", "КПП", "ПолноеНаименование", "СокращённоеНаименование", 
    "Адрес", "Регион", "ТипОрганизации", "РазмерКомпании", "ГруппаПоставщика"
)
SELECT 
    s."ИНН",
    s."КПП",
    s."ПолноеНаименование",
    s."СокращённоеНаименование",
    s."Адрес",
    CASE 
        WHEN s."Адрес" ILIKE '%москва%' THEN 'Москва'
        WHEN s."Адрес" ILIKE '%спб%' OR s."Адрес" ILIKE '%санкт-петербург%' THEN 'СПб'
        ELSE 'Регион'
    END as "Регион",
    CASE 
        WHEN s."ПолноеНаименование" ILIKE '%ООО%' THEN 'ООО'
        WHEN s."ПолноеНаименование" ILIKE '%АО%' THEN 'АО'
        ELSE 'Прочее'
    END as "ТипОрганизации",
    CASE 
        WHEN s."ПолноеНаименование" ILIKE '%медфарм%' OR s."ПолноеНаименование" ILIKE '%глобал%' THEN 'Крупная'
        WHEN s."ПолноеНаименование" ILIKE '%фарм%' THEN 'Средняя'
        ELSE 'Малая'
    END as "РазмерКомпании",
    CASE 
        WHEN s."ПолноеНаименование" ILIKE '%медфарм%' THEN 'Основной'
        WHEN s."ПолноеНаименование" ILIKE '%глобал%' THEN 'Основной'
        ELSE 'Дополнительный'
    END as "ГруппаПоставщика"
FROM "Поставщики" s;

-- Загрузка измерения "Клиент"
INSERT INTO "DimКлиент" (
    "НомерКарты", "ФИО", "ВозрастнаяГруппа", "Пол", "Регион", 
    "ТипКлиента", "СтатусАктивности", "ДатаРегистрации"
)
SELECT 
    k."НомерКарты",
    k."ФИО",
    CASE 
        WHEN k."ФИО" IS NULL THEN 'Неизвестно'
        ELSE 'Взрослые'  -- Упрощенная категоризация
    END as "ВозрастнаяГруппа",
    CASE 
        WHEN k."ФИО" IS NULL THEN 'Неизвестно'
        WHEN k."ФИО" ~ '[а-я]*а[а-я]*$|[а-я]*в[а-я]*$' THEN 'Женский'
        ELSE 'Мужской'
    END as "Пол",
    'Местный' as "Регион",
    CASE 
        WHEN k."НомерКарты" IS NOT NULL THEN 'Регистрированный'
        ELSE 'Анонимный'
    END as "ТипКлиента",
    'Активный' as "СтатусАктивности",
    k."ДатаРегистрации"
FROM "Клиенты" k;

-- Добавляем запись для анонимных клиентов
INSERT INTO "DimКлиент" ("НомерКарты", "ФИО", "ВозрастнаяГруппа", "Пол", "Регион", "ТипКлиента", "СтатусАктивности")
VALUES (NULL, 'Анонимный покупатель', 'Неизвестно', 'Неизвестно', 'Неизвестно', 'Анонимный', 'Активный');

-- Загрузка измерения "СтранаПроизводитель"
INSERT INTO "DimСтранаПроизводитель" (
    "КодОКСМ", "НаименованиеСтраны", "Континент", "ЭкономическийРегион", 
    "УровеньРазвития", "ГруппаПоПроисхождению"
)
SELECT DISTINCT
    s."КодОКСМ",
    s."НаименованиеСтраны",
    CASE 
        WHEN s."КодОКСМ" IN (643, 112, 398, 417) THEN 'Азия'
        WHEN s."КодОКСМ" IN (276, 250, 380, 756, 826) THEN 'Европа'
        WHEN s."КодОКСМ" IN (840, 124) THEN 'Северная Америка'
        WHEN s."КодОКСМ" IN (704) THEN 'Азия'
        ELSE 'Прочее'
    END as "Континент",
    CASE 
        WHEN s."КодОКСМ" = 643 THEN 'СНГ'
        WHEN s."КодОКСМ" IN (276, 250, 380, 756, 826) THEN 'ЕС'
        WHEN s."КодОКСМ" IN (840, 124) THEN 'НАФТА'
        WHEN s."КодОКСМ" = 392 THEN 'АТР'
        ELSE 'Прочие'
    END as "ЭкономическийРегион",
    CASE 
        WHEN s."КодОКСМ" IN (276, 250, 380, 756, 826, 840, 124) THEN 'Развитая'
        WHEN s."КодОКСМ" IN (643, 392, 704, 398, 417) THEN 'Развивающаяся'
        ELSE 'Неопределен'
    END as "УровеньРазвития",
    CASE 
        WHEN s."КодОКСМ" = 643 THEN 'Отечественный'
        ELSE 'Импорт'
    END as "ГруппаПоПроисхождению"
FROM "Страны" s;

-- =====================================================
-- 5. ЗАГРУЗКА ДАННЫХ В ФАКТ-ТАБЛИЦУ
-- =====================================================

-- Загрузка фактов из операционной БД
INSERT INTO "FactПродажи" (
    "КлючВремя", "КлючЛекарство", "КлючПоставщик", "КлючКлиент", "КлючСтрана",
    "КоличествоПродано", "Выручка", "Себестоимость", "НомерЧека", 
    "НомерСерии", "СрокГодности", "ЦенаПродажи", "ЦенаЗакупки"
)
SELECT 
    -- Ключи измерений
    EXTRACT(YEAR FROM c."ДатаВремя")::INTEGER * 10000 + 
    EXTRACT(MONTH FROM c."ДатаВремя")::INTEGER * 100 + 
    EXTRACT(DAY FROM c."ДатаВремя")::INTEGER as "КлючВремя",
    
    dl."КлючЛекарство" as "КлючЛекарство",
    dp."КлючПоставщик" as "КлючПоставщик",
    COALESCE(dk."КлючКлиент", (SELECT "КлючКлиент" FROM "DimКлиент" WHERE "ФИО" = 'Анонимный покупатель')) as "КлючКлиент",
    dstr."КлючСтрана" as "КлючСтрана",
    
    -- Меры
    pc."КоличествоПродано" as "КоличествоПродано",
    (pc."КоличествоПродано" * p."ЦенаПродажи") as "Выручка",
    (pc."КоличествоПродано" * p."ЦенаЗакупки") as "Себестоимость",
    
    -- Детальная информация
    c."НомерЧека" as "НомерЧека",
    p."НомерСерии" as "НомерСерии",
    p."СрокГодности" as "СрокГодности",
    p."ЦенаПродажи" as "ЦенаПродажи",
    p."ЦенаЗакупки" as "ЦенаЗакупки"
    
FROM "Чеки" c
JOIN "ПозицииЧека" pc ON c."НомерЧека" = pc."НомерЧека"
JOIN "Партии" p ON (
    pc."РегНомерЛС" = p."РегНомерЛС" AND
    pc."ИНН" = p."ИНН" AND
    pc."КПП" = p."КПП" AND
    pc."НомерСерии" = p."НомерСерии"
)
JOIN "ЛекарственныеСредства" ls ON p."РегНомерЛС" = ls."РегНомерЛС"
JOIN "Поставщики" s ON (p."ИНН", p."КПП") = (s."ИНН", s."КПП")
JOIN "Страны" str ON ls."КодОКСМ" = str."КодОКСМ"
LEFT JOIN "Клиенты" k ON c."IDКлиента" = k."IDКлиента"

-- Соединение с измерениями для получения ключей
JOIN "DimЛекарственноеСредство" dl ON ls."РегНомерЛС" = dl."РегНомерЛС"
JOIN "DimПоставщик" dp ON (s."ИНН", s."КПП") = (dp."ИНН", dp."КПП")
JOIN "DimСтранаПроизводитель" dstr ON str."КодОКСМ" = dstr."КодОКСМ"
LEFT JOIN "DimКлиент" dk ON k."IDКлиента" = dk."КлючКлиент";

-- =====================================================
-- 6. АНАЛИТИЧЕСКИЕ ЗАПРОСЫ К СХЕМЕ ЗВЕЗДА
-- =====================================================

-- Запрос 1: Анализ продаж по месяцам и категориям
SELECT 
    dv."Год",
    dv."Месяц",
    dv."НазваниеМесяца",
    dl."КатегорияТовара",
    SUM(fp."КоличествоПродано") as "ОбщееКоличество",
    ROUND(SUM(fp."Выручка"), 2) as "ОбщаяВыручка",
    ROUND(SUM(fp."ВаловаяПрибыль"), 2) as "ВаловаяПрибыль",
    ROUND(AVG(fp."ВаловаяПрибыль"), 2) as "СредняяПрибыль",
    COUNT(DISTINCT fp."НомерЧека") as "КоличествоЧеков"
FROM "FactПродажи" fp
JOIN "DimВремя" dv ON fp."КлючВремя" = dv."КлючВремя"
JOIN "DimЛекарственноеСредство" dl ON fp."КлючЛекарство" = dl."КлючЛекарство"
GROUP BY dv."Год", dv."Месяц", dv."НазваниеМесяца", dl."КатегорияТовара"
ORDER BY dv."Год", dv."Месяц", "ОбщаяВыручка" DESC;

-- Запрос 2: Анализ эффективности поставщиков
SELECT 
    dp."ПолноеНаименование" as "Поставщик",
    dp."ГруппаПоставщика",
    dp."Регион",
    COUNT(DISTINCT dl."КлючЛекарство") as "КоличествоТоваров",
    SUM(fp."КоличествоПродано") as "ОбщееКоличество",
    ROUND(SUM(fp."Выручка"), 2) as "ОбщаяВыручка",
    ROUND(SUM(fp."ВаловаяПрибыль"), 2) as "ВаловаяПрибыль",
    ROUND((SUM(fp."ВаловаяПрибыль") * 100.0 / NULLIF(SUM(fp."Выручка"), 0)), 2) as "РентабельностьПроцентов"
FROM "FactПродажи" fp
JOIN "DimПоставщик" dp ON fp."КлючПоставщик" = dp."КлючПоставщик"
JOIN "DimЛекарственноеСредство" dl ON fp."КлючЛекарство" = dl."КлючЛекарство"
GROUP BY dp."ПолноеНаименование", dp."ГруппаПоставщика", dp."Регион"
ORDER BY "ОбщаяВыручка" DESC;

-- Запрос 3: Анализ клиентского поведения
SELECT 
    dk."ТипКлиента",
    COUNT(DISTINCT dk."КлючКлиент") as "КоличествоКлиентов",
    COUNT(DISTINCT fp."НомерЧека") as "КоличествоЧеков",
    ROUND(AVG(fp."Выручка"), 2) as "СреднийЧек",
    ROUND(SUM(fp."Выручка"), 2) as "ОбщаяВыручка",
    dv."НазваниеДняНедели" as "ДеньНедели",
    COUNT(*) as "КоличествоПродажВДень"
FROM "FactПродажи" fp
JOIN "DimКлиент" dk ON fp."КлючКлиент" = dk."КлючКлиент"
JOIN "DimВремя" dv ON fp."КлючВремя" = dv."КлючВремя"
GROUP BY dk."ТипКлиента", dv."НазваниеДняНедели"
ORDER BY dk."ТипКлиента", "ОбщаяВыручка" DESC;

-- Запрос 4: Анализ географии поставок
SELECT 
    dstr."НаименованиеСтраны",
    dstr."ГруппаПоПроисхождению",
    dstr."Континент",
    COUNT(DISTINCT dl."КлючЛекарство") as "КоличествоТоваров",
    SUM(fp."КоличествоПродано") as "ОбщееКоличество",
    ROUND(SUM(fp."Выручка"), 2) as "ОбщаяВыручка",
    ROUND(AVG(fp."ЦенаПродажи"), 2) as "СредняяЦена"
FROM "FactПродажи" fp
JOIN "DimСтранаПроизводитель" dstr ON fp."КлючСтрана" = dstr."КлючСтрана"
JOIN "DimЛекарственноеСредство" dl ON fp."КлючЛекарство" = dl."КлючЛекарство"
GROUP BY dstr."НаименованиеСтраны", dstr."ГруппаПоПроисхождению", dstr."Континент"
ORDER BY "ОбщаяВыручка" DESC;

-- Запрос 5: Трендовый анализ с оконными функциями
WITH ПродажиПоМесяцам AS (
    SELECT 
        dv."Год",
        dv."Месяц",
        dv."НазваниеМесяца",
        SUM(fp."Выручка") as "ВыручкаЗаМесяц"
    FROM "FactПродажи" fp
    JOIN "DimВремя" dv ON fp."КлючВремя" = dv."КлючВремя"
    GROUP BY dv."Год", dv."Месяц", dv."НазваниеМесяца"
)
SELECT 
    "Год",
    "Месяц",
    "НазваниеМесяца",
    "ВыручкаЗаМесяц",
    LAG("ВыручкаЗаМесяц") OVER (ORDER BY "Год", "Месяц") as "ВыручкаПредыдущегоМесяца",
    CASE 
        WHEN LAG("ВыручкаЗаМесяц") OVER (ORDER BY "Год", "Месяц") IS NOT NULL 
        THEN ROUND((("ВыручкаЗаМесяц" - LAG("ВыручкаЗаМесяц") OVER (ORDER BY "Год", "Месяца")) * 100.0) / 
                   LAG("ВыручкаЗаМесяц") OVER (ORDER BY "Год", "Месяц"), 2)
        ELSE NULL 
    END as "ИзменениеПроцентов",
    ROW_NUMBER() OVER (ORDER BY "ВыручкаЗаМесяц" DESC) as "РангПоВыручке"
FROM ПродажиПоМесяцам
ORDER BY "Год", "Месяц";
